<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title><%= editUser ? 'Editar usuário' : 'Novo usuário' %> | Portal</title>
  <link rel="stylesheet" href="/css/dashboard.css" />
</head>
<body class="dashboard-page">
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <img src="/img/logo.png" alt="Logo da empresa">
    </div>

    <nav class="sidebar-menu">
      <a href="/dashboard?module=PLEX" class="sidebar-item" data-module="PLEX">PLEX</a>
      <a href="/dashboard?module=GDR" class="sidebar-item" data-module="GDR">Gerenciamento Diário da Rotina</a>
      <a href="/dashboard?module=UGB" class="sidebar-item" data-module="UGB">UGB</a>

      <% if (user && user.isAdmin) { %>
        <a href="/users" class="sidebar-item active" data-module="USERS">Usuários</a>
        <a href="/departments" class="sidebar-item" data-module="DEPARTMENTS">Departamentos</a>
      <% } %>
    </nav>

    <div class="sidebar-footer">
      <a href="/logout" class="sidebar-logout">Sair</a>
    </div>
  </aside>

  <!-- CONTEÚDO -->
  <main class="content">
    <header class="dashboard-header">
      <div class="dashboard-header-left">
        <h1 class="dashboard-title"><%= editUser ? 'Editar usuário' : 'Novo usuário' %></h1>
        <p class="dashboard-subtitle">Cadastro de usuários do portal</p>
      </div>
      <div class="dashboard-header-right">
        <span class="dashboard-user-email"><%= user.email %></span>
      </div>
    </header>

    <section class="dashboard-panel">
      <div class="dashboard-panel-header">
        <h2 class="dashboard-panel-title">Dados do usuário</h2>
      </div>

      <% if (error) { %>
        <p class="users-form-error"><%= error %></p>
      <% } %>

      <form method="POST" action="<%= editUser ? '/users/' + editUser.email + '/edit' : '/users/new' %>">

        <div class="form-row">
          <label for="nome">Nome</label>
          <input type="text" id="nome" name="nome" required
                 value="<%= editUser ? (editUser.nome || '') : '' %>" />
        </div>

        <div class="form-row">
          <label for="tipoPessoa">Tipo</label>
          <select id="tipoPessoa" name="tipoPessoa" required>
            <option value="PF" <%= (editUser && (editUser.tipoPessoa||'PF') === 'PF') ? 'selected' : '' %>>PF</option>
            <option value="PJ" <%= (editUser && (editUser.tipoPessoa||'PF') === 'PJ') ? 'selected' : '' %>>PJ</option>
          </select>
        </div>

        <div class="form-row" id="cpfRow">
          <label for="cpf">CPF (somente PF)</label>
          <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00"
                 value="<%= editUser && editUser.cpf ? editUser.cpf : '' %>" />
        </div>

        <div class="form-row">
          <label for="email">E-mail</label>
          <input type="email" id="email" name="email" required
                 value="<%= editUser ? (editUser.email || '') : '' %>" />
        </div>

        <div class="form-row">
          <label for="senha"><%= editUser ? 'Senha (deixe em branco para manter)' : 'Senha' %></label>
          <input type="password" id="senha" name="senha" <%= editUser ? '' : 'required' %> />
        </div>

        <!-- DEPARTAMENTOS (múltiplos) -->
        <div class="form-row">
          <label>Departamentos</label>

          <% const selectedDeps = (editUser && Array.isArray(editUser.departamentos)) ? editUser.departamentos : []; %>

          <% if (!departments || departments.length === 0) { %>
            <div style="opacity:.8;">Nenhum departamento cadastrado. Cadastre em “Departamentos”.</div>
          <% } else { %>
            <% departments.forEach(d => { %>
              <label class="checkbox-label">
                <input type="checkbox" name="departamentos" value="<%= d.id %>"
                  <%= selectedDeps.includes(d.id) ? 'checked' : '' %> />
                <%= d.nome %>
              </label>
            <% }) %>
          <% } %>
        </div>

        <!-- RELATÓRIOS (múltiplos) -->
        <div class="form-row">
          <label>Relatórios liberados</label>

          <% const selectedReports = (editUser && Array.isArray(editUser.relatorios)) ? editUser.relatorios : []; %>

          <label class="checkbox-label">
            <input type="checkbox" name="relatorios" value="PLEX"
              <%= selectedReports.includes('PLEX') ? 'checked' : '' %> />
            PLEX
          </label>

          <label class="checkbox-label">
            <input type="checkbox" name="relatorios" value="GDR"
              <%= selectedReports.includes('GDR') ? 'checked' : '' %> />
            GDR
          </label>

          <label class="checkbox-label">
            <input type="checkbox" name="relatorios" value="UGB"
              <%= selectedReports.includes('UGB') ? 'checked' : '' %> />
            UGB
          </label>
        </div>

        <div class="form-row form-row-inline">
          <label class="checkbox-label">
            <input type="checkbox" name="ativo"
              <%= editUser ? (editUser.ativo ? 'checked' : '') : 'checked' %> />
            Usuário ativo
          </label>
        </div>

        <div class="form-row form-row-inline">
          <label class="checkbox-label">
            <input type="checkbox" name="isAdmin"
              <%= editUser && editUser.isAdmin ? 'checked' : '' %> />
            Admin
          </label>
        </div>

        <div class="form-actions">
          <a href="/users" class="btn-secondary">Cancelar</a>
          <button type="submit" class="btn-primary">
            <%= editUser ? 'Salvar alterações' : 'Salvar usuário' %>
          </button>
        </div>
      </form>
    </section>
  </main>
</div>

<script>
  const tipo = document.getElementById('tipoPessoa');
  const cpfRow = document.getElementById('cpfRow');
  const cpf = document.getElementById('cpf');

  function toggleCpf() {
    const isPJ = tipo.value === 'PJ';
    cpfRow.style.display = isPJ ? 'none' : '';
    cpf.required = !isPJ;
    if (isPJ) cpf.value = '';
  }

  tipo.addEventListener('change', toggleCpf);
  toggleCpf();
</script>

</body>
</html>